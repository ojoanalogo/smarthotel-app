"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var http_1 = require("@angular/http");
var Observable_1 = require("rxjs/Observable");
var place_model_1 = require("../models/place.model");
var backend_service_1 = require("../services/backend.service");
var location_service_1 = require("../services/location.service");
var nativescript_secure_storage_1 = require("nativescript-secure-storage");
var connectivity = require("tns-core-modules/connectivity");
require("rxjs/add/operator/map");
require("rxjs/add/operator/do");
var PlacesService = (function () {
    function PlacesService(http, locationService) {
        this.http = http;
        this.locationService = locationService;
        this.secureStorage = new nativescript_secure_storage_1.SecureStorage();
    }
    PlacesService.prototype.getPlaces = function (location) {
        var _this = this;
        if (connectivity.getConnectionType() == connectivity.connectionType.none) {
            return Observable_1.Observable.throw("");
        }
        var places = [];
        var apiKEY = "AIzaSyC3t37wmitrNWtfbKcIyfjRbKN8yp7duLk";
        var url = backend_service_1.BackendService.placesGoogleURL + "key=" + apiKEY + "&location="
            + location.latitude.toString() + "," + location.longitude.toString() + "&radius=10000&language=es&types=";
        var parks = this.http.get(url + place_model_1.PlaceType.PARK).map(function (res) { return res.json(); });
        var restaurants = this.http.get(url + place_model_1.PlaceType.RESTAURANT).map(function (res) { return res.json(); });
        var museums = this.http.get(url + place_model_1.PlaceType.MUSEUM).map(function (res) { return res.json(); });
        var art_galleries = this.http.get(url + place_model_1.PlaceType.ART_GALLERY).map(function (res) { return res.json(); });
        var cafes = this.http.get(url + place_model_1.PlaceType.CAFE).map(function (res) { return res.json(); });
        var casinos = this.http.get(url + place_model_1.PlaceType.CASINO).map(function (res) { return res.json(); });
        var zoo = this.http.get(url + place_model_1.PlaceType.ZOO).map(function (res) { return res.json(); });
        var shopping = this.http.get(url + place_model_1.PlaceType.SHOPPING_MALL).map(function (res) { return res.json(); });
        var bars = this.http.get(url + place_model_1.PlaceType.BAR).map(function (res) { return res.json(); });
        var night_clubs = this.http.get(url + place_model_1.PlaceType.NIGHT_CLUB).map(function (res) { return res.json(); });
        return Observable_1.Observable.forkJoin([parks, restaurants, museums, art_galleries, cafes,
            casinos, zoo, shopping, bars, night_clubs]).map(function (data) {
            var placeType;
            var i = 0;
            data.forEach(function (dataTypes) {
                dataTypes["results"].forEach(function (place) {
                    var ref;
                    if ('photos' in place) {
                        ref = place.photos[0].photo_reference;
                    }
                    else {
                        ref = "null";
                    }
                    places.push(new place_model_1.Place(place.place_id, place.name, place.geometry.location, _this.getPlaceType(i), ref));
                });
                i++;
            });
            return places;
        });
    };
    PlacesService.prototype.placesExist = function () {
        return this.secureStorage.get({ key: "placesData" });
        // let val = this.secureStorage.getSync({key: "placesData"});
        // return (val==null) ? false : true;
    };
    PlacesService.prototype.getDistancePlace = function (placeLocation) {
        var distance = this.locationService.getDistance(this.locationService.getLocation(), placeLocation);
        if (distance >= 1) {
            return (distance).toFixed(1) + " kilometros";
        }
        return (distance * 1000).toFixed(0) + " metros";
    };
    PlacesService.prototype.getPlaceType = function (i) {
        var place;
        switch (i) {
            case 0: return place_model_1.PlaceType.PARK;
            case 1: return place_model_1.PlaceType.RESTAURANT;
            case 2: return place_model_1.PlaceType.MUSEUM;
            case 3: return place_model_1.PlaceType.ART_GALLERY;
            case 4: return place_model_1.PlaceType.CAFE;
            case 5: return place_model_1.PlaceType.CASINO;
            case 6: return place_model_1.PlaceType.ZOO;
            case 7: return place_model_1.PlaceType.SHOPPING_MALL;
            case 8: return place_model_1.PlaceType.BAR;
            case 9: return place_model_1.PlaceType.NIGHT_CLUB;
        }
    };
    PlacesService.prototype.storePlaces = function (places) {
        return this.secureStorage.set({ key: "placesData", value: JSON.stringify(places) });
    };
    PlacesService.prototype.getSavedPlaces = function () {
        return this.secureStorage.get({ key: "placesData" });
    };
    PlacesService = __decorate([
        core_1.Injectable(),
        __metadata("design:paramtypes", [http_1.Http, location_service_1.LocationService])
    ], PlacesService);
    return PlacesService;
}());
exports.PlacesService = PlacesService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGxhY2VzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJwbGFjZXMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHNDQUEyQztBQUMzQyxzQ0FBd0Q7QUFDeEQsOENBQTZDO0FBRTdDLHFEQUF5RDtBQUV6RCwrREFBNkQ7QUFDN0QsaUVBQStEO0FBQy9ELDJFQUE0RDtBQUM1RCw0REFBOEQ7QUFFOUQsaUNBQStCO0FBQy9CLGdDQUE4QjtBQUc5QjtJQUVFLHVCQUFvQixJQUFVLEVBQVUsZUFBaUM7UUFBckQsU0FBSSxHQUFKLElBQUksQ0FBTTtRQUFVLG9CQUFlLEdBQWYsZUFBZSxDQUFrQjtRQUN2RSxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksMkNBQWEsRUFBRSxDQUFDO0lBQzFDLENBQUM7SUFFSyxpQ0FBUyxHQUFoQixVQUFpQixRQUFrQjtRQUFuQyxpQkFxQ0M7UUFwQ0MsRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLGlCQUFpQixFQUFFLElBQUksWUFBWSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3pFLE1BQU0sQ0FBQyx1QkFBVSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM5QixDQUFDO1FBQ0QsSUFBSSxNQUFNLEdBQWlCLEVBQUUsQ0FBQztRQUM5QixJQUFJLE1BQU0sR0FBRyx5Q0FBeUMsQ0FBQztRQUN2RCxJQUFJLEdBQUcsR0FBRyxnQ0FBYyxDQUFDLGVBQWUsR0FBRyxNQUFNLEdBQUcsTUFBTSxHQUFHLFlBQVk7Y0FDckUsUUFBUSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsR0FBRyxHQUFHLEdBQUcsUUFBUSxDQUFDLFNBQVMsQ0FBQyxRQUFRLEVBQUUsR0FBRyxrQ0FBa0MsQ0FBQztRQUM1RyxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsdUJBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFH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SUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsRUFBQyxHQUFHLEVBQUUsWUFBWSxFQUFDLENBQUMsQ0FBQztJQUNyRCxDQUFDO0lBaEZVLGFBQWE7UUFEekIsaUJBQVUsRUFBRTt5Q0FHZSxXQUFJLEVBQTRCLGtDQUFlO09BRjlELGFBQWEsQ0FrRnpCO0lBQUQsb0JBQUM7Q0FBQSxBQWxGRCxJQWtGQztBQWxGWSxzQ0FBYSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5pbXBvcnQgeyBIdHRwLCBIZWFkZXJzLCBSZXNwb25zZSB9IGZyb20gXCJAYW5ndWxhci9odHRwXCI7XHJcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzL09ic2VydmFibGUnO1xyXG5pbXBvcnQgeyBmb3JrSm9pbiB9IGZyb20gXCJyeGpzL29ic2VydmFibGUvZm9ya0pvaW5cIjtcclxuaW1wb3J0IHsgUGxhY2UsIFBsYWNlVHlwZSB9IGZyb20gXCIuLi9tb2RlbHMvcGxhY2UubW9kZWxcIjtcclxuaW1wb3J0IHsgTG9jYXRpb24gfSBmcm9tIFwiLi4vbW9kZWxzL2xvY2F0aW9uLm1vZGVsXCI7XHJcbmltcG9ydCB7IEJhY2tlbmRTZXJ2aWNlIH0gZnJvbSBcIi4uL3NlcnZpY2VzL2JhY2tlbmQuc2VydmljZVwiO1xyXG5pbXBvcnQgeyBMb2NhdGlvblNlcnZpY2UgfSBmcm9tIFwiLi4vc2VydmljZXMvbG9jYXRpb24uc2VydmljZVwiO1xyXG5pbXBvcnQgeyBTZWN1cmVTdG9yYWdlIH0gZnJvbSBcIm5hdGl2ZXNjcmlwdC1zZWN1cmUtc3RvcmFnZVwiO1xyXG5pbXBvcnQgKiBhcyBjb25uZWN0aXZpdHkgZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvY29ubmVjdGl2aXR5XCI7XHJcblxyXG5pbXBvcnQgXCJyeGpzL2FkZC9vcGVyYXRvci9tYXBcIjtcclxuaW1wb3J0IFwicnhqcy9hZGQvb3BlcmF0b3IvZG9cIjtcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIFBsYWNlc1NlcnZpY2Uge1xyXG4gIHByaXZhdGUgc2VjdXJlU3RvcmFnZSA6IFNlY3VyZVN0b3JhZ2U7XHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwLCBwcml2YXRlIGxvY2F0aW9uU2VydmljZSA6IExvY2F0aW9uU2VydmljZSkge1xyXG4gICAgdGhpcy5zZWN1cmVTdG9yYWdlID0gbmV3IFNlY3VyZVN0b3JhZ2UoKTtcclxuICAgfVxyXG5cclxuICBwdWJsaWMgZ2V0UGxhY2VzKGxvY2F0aW9uOiBMb2NhdGlvbik6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBpZiAoY29ubmVjdGl2aXR5LmdldENvbm5lY3Rpb25UeXBlKCkgPT0gY29ubmVjdGl2aXR5LmNvbm5lY3Rpb25UeXBlLm5vbmUpIHtcclxuICAgICAgcmV0dXJuIE9ic2VydmFibGUudGhyb3coXCJcIik7XHJcbiAgICB9XHJcbiAgICBsZXQgcGxhY2VzOiBBcnJheTxQbGFjZT4gPSBbXTtcclxuICAgIGxldCBhcGlLRVkgPSBcIkFJemFTeUMzdDM3d21pdHJOV3RmYktjSXlmalJiS044eXA3ZHVMa1wiO1xyXG4gICAgbGV0IHVybCA9IEJhY2tlbmRTZXJ2aWNlLnBsYWNlc0dvb2dsZVVSTCArIFwia2V5PVwiICsgYXBpS0VZICsgXCImbG9jYXRpb249XCJcclxuICAgICAgKyBsb2NhdGlvbi5sYXRpdHVkZS50b1N0cmluZygpICsgXCIsXCIgKyBsb2NhdGlvbi5sb25naXR1ZGUudG9TdHJpbmcoKSArIFwiJnJhZGl1cz0xMDAwMCZsYW5ndWFnZT1lcyZ0eXBlcz1cIjtcclxuICAgIGxldCBwYXJrcyA9IHRoaXMuaHR0cC5nZXQodXJsICsgUGxhY2VUeXBlLlBBUkspLm1hcChyZXMgPT4gcmVzLmpzb24oKSk7XHJcbiAgICBsZXQgcmVzdGF1cmFudHMgPSB0aGlzLmh0dHAuZ2V0KHVybCArIFBsYWNlVHlwZS5SRVNUQVVSQU5UKS5tYXAocmVzID0+IHJlcy5qc29uKCkpO1xyXG4gICAgbGV0IG11c2V1bXMgPSB0aGlzLmh0dHAuZ2V0KHVybCArIFBsYWNlVHlwZS5NVVNFVU0pLm1hcChyZXMgPT4gcmVzLmpzb24oKSk7XHJcbiAgICBsZXQgYXJ0X2dhbGxlcmllcyA9IHRoaXMuaHR0cC5nZXQodXJsICsgUGxhY2VUeXBlLkFSVF9HQUxMRVJZKS5tYXAocmVzID0+IHJlcy5qc29uKCkpO1xyXG4gICAgbGV0IGNhZmVzID0gdGhpcy5odHRwLmdldCh1cmwgKyBQbGFjZVR5cGUuQ0FGRSkubWFwKHJlcyA9PiByZXMuanNvbigpKTtcclxuICAgIGxldCBjYXNpbm9zID0gdGhpcy5odHRwLmdldCh1cmwgKyBQbGFjZVR5cGUuQ0FTSU5PKS5tYXAocmVzID0+IHJlcy5qc29uKCkpO1xyXG4gICAgbGV0IHpvbyA9IHRoaXMuaHR0cC5nZXQodXJsICsgUGxhY2VUeXBlLlpPTykubWFwKHJlcyA9PiByZXMuanNvbigpKTtcclxuICAgIGxldCBzaG9wcGluZyA9IHRoaXMuaHR0cC5nZXQodXJsICsgUGxhY2VUeXBlLlNIT1BQSU5HX01BTEwpLm1hcChyZXMgPT4gcmVzLmpzb24oKSk7XHJcbiAgICBsZXQgYmFycyA9IHRoaXMuaHR0cC5nZXQodXJsICsgUGxhY2VUeXBlLkJBUikubWFwKHJlcyA9PiByZXMuanNvbigpKTtcclxuICAgIGxldCBuaWdodF9jbHVicyA9IHRoaXMuaHR0cC5nZXQodXJsICsgUGxhY2VUeXBlLk5JR0hUX0NMVUIpLm1hcChyZXMgPT4gcmVzLmpzb24oKSk7XHJcbiAgICByZXR1cm4gT2JzZXJ2YWJsZS5mb3JrSm9pbihbcGFya3MsIHJlc3RhdXJhbnRzLCBtdXNldW1zLCBhcnRfZ2FsbGVyaWVzLCBjYWZlcyxcclxuICAgICAgY2FzaW5vcywgem9vLCBzaG9wcGluZywgYmFycywgbmlnaHRfY2x1YnNdKS5tYXAoKGRhdGE6IGFueVtdKSA9PiB7XHJcbiAgICAgICAgbGV0IHBsYWNlVHlwZTtcclxuICAgICAgICBsZXQgaSA9IDA7XHJcbiAgICAgICAgZGF0YS5mb3JFYWNoKGRhdGFUeXBlcyA9PiB7XHJcbiAgICAgICAgICBkYXRhVHlwZXNbXCJyZXN1bHRzXCJdLmZvckVhY2gocGxhY2UgPT4ge1xyXG4gICAgICAgICAgICBsZXQgcmVmO1xyXG4gICAgICAgICAgICBpZiAoJ3Bob3RvcycgaW4gcGxhY2UpIHtcclxuICAgICAgICAgICAgICByZWYgPSBwbGFjZS5waG90b3NbMF0ucGhvdG9fcmVmZXJlbmNlO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgIHJlZiA9IFwibnVsbFwiO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHBsYWNlcy5wdXNoKG5ldyBQbGFjZShwbGFjZS5wbGFjZV9pZCwgcGxhY2UubmFtZSxcclxuICAgICAgICAgICAgICBwbGFjZS5nZW9tZXRyeS5sb2NhdGlvbiwgdGhpcy5nZXRQbGFjZVR5cGUoaSksIHJlZikpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgICBpKys7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIHBsYWNlcztcclxuICAgICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgcGxhY2VzRXhpc3QoKTogUHJvbWlzZTxhbnk+IHtcclxuICAgIHJldHVybiB0aGlzLnNlY3VyZVN0b3JhZ2UuZ2V0KHtrZXk6IFwicGxhY2VzRGF0YVwifSk7XHJcbiAgICAvLyBsZXQgdmFsID0gdGhpcy5zZWN1cmVTdG9yYWdlLmdldFN5bmMoe2tleTogXCJwbGFjZXNEYXRhXCJ9KTtcclxuICAgIC8vIHJldHVybiAodmFsPT1udWxsKSA/IGZhbHNlIDogdHJ1ZTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBnZXREaXN0YW5jZVBsYWNlKHBsYWNlTG9jYXRpb24gOiBMb2NhdGlvbikgOiBzdHJpbmcge1xyXG4gICAgIGxldCBkaXN0YW5jZSA9IHRoaXMubG9jYXRpb25TZXJ2aWNlLmdldERpc3RhbmNlKHRoaXMubG9jYXRpb25TZXJ2aWNlLmdldExvY2F0aW9uKCksIHBsYWNlTG9jYXRpb24pO1xyXG4gICAgIGlmKGRpc3RhbmNlID49IDEpIHtcclxuICAgICAgIHJldHVybiAoZGlzdGFuY2UpLnRvRml4ZWQoMSkgKyBcIiBraWxvbWV0cm9zXCI7XHJcbiAgICAgfVxyXG4gICAgIHJldHVybiAoZGlzdGFuY2UqMTAwMCkudG9GaXhlZCgwKSArIFwiIG1ldHJvc1wiO1xyXG4gICB9XHJcblxyXG5cclxuICBwcml2YXRlIGdldFBsYWNlVHlwZShpKTogUGxhY2VUeXBlIHtcclxuICAgIGxldCBwbGFjZTogUGxhY2VUeXBlO1xyXG4gICAgc3dpdGNoIChpKSB7XHJcbiAgICAgIGNhc2UgMDogcmV0dXJuIFBsYWNlVHlwZS5QQVJLO1xyXG4gICAgICBjYXNlIDE6IHJldHVybiBQbGFjZVR5cGUuUkVTVEFVUkFOVDtcclxuICAgICAgY2FzZSAyOiByZXR1cm4gUGxhY2VUeXBlLk1VU0VVTTtcclxuICAgICAgY2FzZSAzOiByZXR1cm4gUGxhY2VUeXBlLkFSVF9HQUxMRVJZO1xyXG4gICAgICBjYXNlIDQ6IHJldHVybiBQbGFjZVR5cGUuQ0FGRTtcclxuICAgICAgY2FzZSA1OiByZXR1cm4gUGxhY2VUeXBlLkNBU0lOTztcclxuICAgICAgY2FzZSA2OiByZXR1cm4gUGxhY2VUeXBlLlpPTztcclxuICAgICAgY2FzZSA3OiByZXR1cm4gUGxhY2VUeXBlLlNIT1BQSU5HX01BTEw7XHJcbiAgICAgIGNhc2UgODogcmV0dXJuIFBsYWNlVHlwZS5CQVI7XHJcbiAgICAgIGNhc2UgOTogcmV0dXJuIFBsYWNlVHlwZS5OSUdIVF9DTFVCO1xyXG4gICAgfVxyXG4gIH1cclxuICBwdWJsaWMgc3RvcmVQbGFjZXMocGxhY2VzOiBBcnJheTxQbGFjZT4pIHtcclxuICAgIHJldHVybiB0aGlzLnNlY3VyZVN0b3JhZ2Uuc2V0KHtrZXk6IFwicGxhY2VzRGF0YVwiLCB2YWx1ZTogSlNPTi5zdHJpbmdpZnkocGxhY2VzKX0pO1xyXG4gIH1cclxuICBwdWJsaWMgZ2V0U2F2ZWRQbGFjZXMoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5zZWN1cmVTdG9yYWdlLmdldCh7a2V5OiBcInBsYWNlc0RhdGFcIn0pO1xyXG4gIH1cclxuXHJcbn1cclxuIl19