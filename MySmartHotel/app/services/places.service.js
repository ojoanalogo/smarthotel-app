"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var http_1 = require("@angular/http");
var Observable_1 = require("rxjs/Observable");
var place_model_1 = require("../models/place.model");
var backend_service_1 = require("../services/backend.service");
var nativescript_secure_storage_1 = require("nativescript-secure-storage");
var connectivity = require("tns-core-modules/connectivity");
require("rxjs/add/operator/map");
require("rxjs/add/operator/do");
var PlacesService = (function () {
    function PlacesService(http) {
        this.http = http;
        this.secureStorage = new nativescript_secure_storage_1.SecureStorage();
    }
    PlacesService.prototype.getPlaces = function (location) {
        var _this = this;
        if (connectivity.getConnectionType() == connectivity.connectionType.none) {
            return Observable_1.Observable.throw("");
        }
        var places = [];
        var apiKEY = "AIzaSyC3t37wmitrNWtfbKcIyfjRbKN8yp7duLk";
        var url = backend_service_1.BackendService.placesGoogleURL + "key=" + apiKEY + "&location="
            + location.latitude.toString() + "," + location.longitude.toString() + "&radius=10000&language=es&types=";
        var parks = this.http.get(url + place_model_1.PlaceType.PARK).map(function (res) { return res.json(); });
        var restaurants = this.http.get(url + place_model_1.PlaceType.RESTAURANT).map(function (res) { return res.json(); });
        var museums = this.http.get(url + place_model_1.PlaceType.MUSEUM).map(function (res) { return res.json(); });
        var art_galleries = this.http.get(url + place_model_1.PlaceType.ART_GALLERY).map(function (res) { return res.json(); });
        var cafes = this.http.get(url + place_model_1.PlaceType.CAFE).map(function (res) { return res.json(); });
        var casinos = this.http.get(url + place_model_1.PlaceType.CASINO).map(function (res) { return res.json(); });
        var zoo = this.http.get(url + place_model_1.PlaceType.ZOO).map(function (res) { return res.json(); });
        var shopping = this.http.get(url + place_model_1.PlaceType.SHOPPING_MALL).map(function (res) { return res.json(); });
        var bars = this.http.get(url + place_model_1.PlaceType.BAR).map(function (res) { return res.json(); });
        var night_clubs = this.http.get(url + place_model_1.PlaceType.NIGHT_CLUB).map(function (res) { return res.json(); });
        var points_of_interest = this.http.get(url + place_model_1.PlaceType.POINT_OF_INTEREST).map(function (res) { return res.json(); });
        return Observable_1.Observable.forkJoin([parks, restaurants, museums, art_galleries, cafes,
            casinos, zoo, shopping, bars, night_clubs, points_of_interest]).map(function (data) {
            var placeType;
            var i = 0;
            data.forEach(function (dataTypes) {
                dataTypes["results"].forEach(function (place) {
                    var ref;
                    if ('photos' in place) {
                        ref = place.photos[0].photo_reference;
                    }
                    else {
                        ref = "null";
                    }
                    places.push(new place_model_1.Place(place.place_id, place.name, place.geometry.location, _this.getPlaceType(i), ref));
                });
                i++;
            });
            return places;
        });
    };
    PlacesService.prototype.placesExist = function () {
        var val = this.secureStorage.getSync({ key: "placesData" });
        return (val == null) ? false : true;
    };
    PlacesService.prototype.getPlaceType = function (i) {
        var place;
        switch (i) {
            case 0: return place_model_1.PlaceType.PARK;
            case 1: return place_model_1.PlaceType.RESTAURANT;
            case 2: return place_model_1.PlaceType.MUSEUM;
            case 3: return place_model_1.PlaceType.ART_GALLERY;
            case 4: return place_model_1.PlaceType.CAFE;
            case 5: return place_model_1.PlaceType.CASINO;
            case 6: return place_model_1.PlaceType.ZOO;
            case 7: return place_model_1.PlaceType.SHOPPING_MALL;
            case 8: return place_model_1.PlaceType.BAR;
            case 9: return place_model_1.PlaceType.NIGHT_CLUB;
            case 10: return place_model_1.PlaceType.POINT_OF_INTEREST;
        }
    };
    PlacesService.prototype.storePlaces = function (places) {
        return this.secureStorage.set({ key: "placesData", value: JSON.stringify(places) });
    };
    PlacesService.prototype.getSavedPlaces = function () {
        return this.secureStorage.get({ key: "placesData" });
    };
    PlacesService = __decorate([
        core_1.Injectable(),
        __metadata("design:paramtypes", [http_1.Http])
    ], PlacesService);
    return PlacesService;
}());
exports.PlacesService = PlacesService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGxhY2VzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJwbGFjZXMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHNDQUEyQztBQUMzQyxzQ0FBd0Q7QUFDeEQsOENBQTZDO0FBRTdDLHFEQUF5RDtBQUV6RCwrREFBNkQ7QUFDN0QsMkVBQTREO0FBQzVELDREQUE4RDtBQUU5RCxpQ0FBK0I7QUFDL0IsZ0NBQThCO0FBRzlCO0lBRUUsdUJBQW9CLElBQVU7UUFBVixTQUFJLEdBQUosSUFBSSxDQUFNO1FBQzVCLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSwyQ0FBYSxFQUFFLENBQUM7SUFDMUMsQ0FBQztJQUVLLGlDQUFTLEdBQWhCLFVBQWlCLFFBQWtCO1FBQW5DLGlCQXNDQztRQXJDQyxFQUFFLENBQUMsQ0FBQyxZQUFZLENBQUMsaUJBQWlCLEVBQUUsSUFBSSxZQUFZLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDekUsTUFBTSxDQUFDLHVCQUFVLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzlCLENBQUM7UUFDRCxJQUFJLE1BQU0sR0FBaUIsRUFBRSxDQUFDO1FBQzlCLElBQUksTUFBTSxHQUFHLHlDQUF5QyxDQUFDO1FBQ3ZELElBQUksR0FBRyxHQUFHLGdDQUFjLENBQUMsZUFBZSxHQUFHLE1BQU0sR0FBRyxNQUFNLEdBQUcsWUFBWTtjQUNyRSxRQUFRLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxHQUFHLEdBQUcsR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxHQUFHLGtDQUFrQyxDQUFDO1FBQzVHLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyx1QkFBUyxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxVQUFBLEdBQUcsSUFBSSxPQUFBLEdBQUcsQ0FBQyxJQUFJLEVBQUUsRUFBVixDQUFVLENBQUMsQ0FBQztRQUN2RSxJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsdUJBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBQSxHQUFHLElBQUksT0FBQSxHQUFHLENBQUMsSUFBSSxFQUFFLEVBQVYsQ0FBVSxDQUFDLENBQUM7UUFDbkYsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLHVCQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsR0FBRyxDQUFDLElBQUksRUFBRSxFQUFWLENBQVUsQ0FBQyxDQUFDO1FBQzNFLElBQUksYUFBYSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyx1QkFBUyxDQUFDLFdBQVcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxVQUFBLEdBQUcsSUFBSSxPQUFBLEdBQUcsQ0FBQyxJQUFJLEVBQUUsRUFBVixDQUFVLENBQUMsQ0FBQztRQUN0RixJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsdUJBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBQSxHQUFHLElBQUksT0FBQSxHQUFHLENBQUMsSUFBSSxFQUFFLEVBQVYsQ0FBVSxDQUFDLENBQUM7UUFDdkUsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLHVCQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsR0FBRyxDQUFDLElBQUksRUFBRSxFQUFWLENBQVUsQ0FBQyxDQUFDO1FBQzNFLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyx1QkFBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxVQUFB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QUQsb0JBQUM7Q0FBQSxBQTFFRCxJQTBFQztBQTFFWSxzQ0FBYSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5pbXBvcnQgeyBIdHRwLCBIZWFkZXJzLCBSZXNwb25zZSB9IGZyb20gXCJAYW5ndWxhci9odHRwXCI7XHJcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzL09ic2VydmFibGUnO1xyXG5pbXBvcnQgeyBmb3JrSm9pbiB9IGZyb20gXCJyeGpzL29ic2VydmFibGUvZm9ya0pvaW5cIjtcclxuaW1wb3J0IHsgUGxhY2UsIFBsYWNlVHlwZSB9IGZyb20gXCIuLi9tb2RlbHMvcGxhY2UubW9kZWxcIjtcclxuaW1wb3J0IHsgTG9jYXRpb24gfSBmcm9tIFwiLi4vbW9kZWxzL2xvY2F0aW9uLm1vZGVsXCI7XHJcbmltcG9ydCB7IEJhY2tlbmRTZXJ2aWNlIH0gZnJvbSBcIi4uL3NlcnZpY2VzL2JhY2tlbmQuc2VydmljZVwiO1xyXG5pbXBvcnQgeyBTZWN1cmVTdG9yYWdlIH0gZnJvbSBcIm5hdGl2ZXNjcmlwdC1zZWN1cmUtc3RvcmFnZVwiO1xyXG5pbXBvcnQgKiBhcyBjb25uZWN0aXZpdHkgZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvY29ubmVjdGl2aXR5XCI7XHJcblxyXG5pbXBvcnQgXCJyeGpzL2FkZC9vcGVyYXRvci9tYXBcIjtcclxuaW1wb3J0IFwicnhqcy9hZGQvb3BlcmF0b3IvZG9cIjtcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIFBsYWNlc1NlcnZpY2Uge1xyXG4gIHByaXZhdGUgc2VjdXJlU3RvcmFnZSA6IFNlY3VyZVN0b3JhZ2U7XHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwKSB7XHJcbiAgICB0aGlzLnNlY3VyZVN0b3JhZ2UgPSBuZXcgU2VjdXJlU3RvcmFnZSgpO1xyXG4gICB9XHJcblxyXG4gIHB1YmxpYyBnZXRQbGFjZXMobG9jYXRpb246IExvY2F0aW9uKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGlmIChjb25uZWN0aXZpdHkuZ2V0Q29ubmVjdGlvblR5cGUoKSA9PSBjb25uZWN0aXZpdHkuY29ubmVjdGlvblR5cGUubm9uZSkge1xyXG4gICAgICByZXR1cm4gT2JzZXJ2YWJsZS50aHJvdyhcIlwiKTtcclxuICAgIH1cclxuICAgIGxldCBwbGFjZXM6IEFycmF5PFBsYWNlPiA9IFtdO1xyXG4gICAgbGV0IGFwaUtFWSA9IFwiQUl6YVN5QzN0Mzd3bWl0ck5XdGZiS2NJeWZqUmJLTjh5cDdkdUxrXCI7XHJcbiAgICBsZXQgdXJsID0gQmFja2VuZFNlcnZpY2UucGxhY2VzR29vZ2xlVVJMICsgXCJrZXk9XCIgKyBhcGlLRVkgKyBcIiZsb2NhdGlvbj1cIlxyXG4gICAgICArIGxvY2F0aW9uLmxhdGl0dWRlLnRvU3RyaW5nKCkgKyBcIixcIiArIGxvY2F0aW9uLmxvbmdpdHVkZS50b1N0cmluZygpICsgXCImcmFkaXVzPTEwMDAwJmxhbmd1YWdlPWVzJnR5cGVzPVwiO1xyXG4gICAgbGV0IHBhcmtzID0gdGhpcy5odHRwLmdldCh1cmwgKyBQbGFjZVR5cGUuUEFSSykubWFwKHJlcyA9PiByZXMuanNvbigpKTtcclxuICAgIGxldCByZXN0YXVyYW50cyA9IHRoaXMuaHR0cC5nZXQodXJsICsgUGxhY2VUeXBlLlJFU1RBVVJBTlQpLm1hcChyZXMgPT4gcmVzLmpzb24oKSk7XHJcbiAgICBsZXQgbXVzZXVtcyA9IHRoaXMuaHR0cC5nZXQodXJsICsgUGxhY2VUeXBlLk1VU0VVTSkubWFwKHJlcyA9PiByZXMuanNvbigpKTtcclxuICAgIGxldCBhcnRfZ2FsbGVyaWVzID0gdGhpcy5odHRwLmdldCh1cmwgKyBQbGFjZVR5cGUuQVJUX0dBTExFUlkpLm1hcChyZXMgPT4gcmVzLmpzb24oKSk7XHJcbiAgICBsZXQgY2FmZXMgPSB0aGlzLmh0dHAuZ2V0KHVybCArIFBsYWNlVHlwZS5DQUZFKS5tYXAocmVzID0+IHJlcy5qc29uKCkpO1xyXG4gICAgbGV0IGNhc2lub3MgPSB0aGlzLmh0dHAuZ2V0KHVybCArIFBsYWNlVHlwZS5DQVNJTk8pLm1hcChyZXMgPT4gcmVzLmpzb24oKSk7XHJcbiAgICBsZXQgem9vID0gdGhpcy5odHRwLmdldCh1cmwgKyBQbGFjZVR5cGUuWk9PKS5tYXAocmVzID0+IHJlcy5qc29uKCkpO1xyXG4gICAgbGV0IHNob3BwaW5nID0gdGhpcy5odHRwLmdldCh1cmwgKyBQbGFjZVR5cGUuU0hPUFBJTkdfTUFMTCkubWFwKHJlcyA9PiByZXMuanNvbigpKTtcclxuICAgIGxldCBiYXJzID0gdGhpcy5odHRwLmdldCh1cmwgKyBQbGFjZVR5cGUuQkFSKS5tYXAocmVzID0+IHJlcy5qc29uKCkpO1xyXG4gICAgbGV0IG5pZ2h0X2NsdWJzID0gdGhpcy5odHRwLmdldCh1cmwgKyBQbGFjZVR5cGUuTklHSFRfQ0xVQikubWFwKHJlcyA9PiByZXMuanNvbigpKTtcclxuICAgIGxldCBwb2ludHNfb2ZfaW50ZXJlc3QgPSB0aGlzLmh0dHAuZ2V0KHVybCArIFBsYWNlVHlwZS5QT0lOVF9PRl9JTlRFUkVTVCkubWFwKHJlcyA9PiByZXMuanNvbigpKTtcclxuICAgIHJldHVybiBPYnNlcnZhYmxlLmZvcmtKb2luKFtwYXJrcywgcmVzdGF1cmFudHMsIG11c2V1bXMsIGFydF9nYWxsZXJpZXMsIGNhZmVzLFxyXG4gICAgICBjYXNpbm9zLCB6b28sIHNob3BwaW5nLCBiYXJzLCBuaWdodF9jbHVicywgcG9pbnRzX29mX2ludGVyZXN0XSkubWFwKChkYXRhOiBhbnlbXSkgPT4ge1xyXG4gICAgICAgIGxldCBwbGFjZVR5cGU7XHJcbiAgICAgICAgbGV0IGkgPSAwO1xyXG4gICAgICAgIGRhdGEuZm9yRWFjaChkYXRhVHlwZXMgPT4ge1xyXG4gICAgICAgICAgZGF0YVR5cGVzW1wicmVzdWx0c1wiXS5mb3JFYWNoKHBsYWNlID0+IHtcclxuICAgICAgICAgICAgbGV0IHJlZjtcclxuICAgICAgICAgICAgaWYgKCdwaG90b3MnIGluIHBsYWNlKSB7XHJcbiAgICAgICAgICAgICAgcmVmID0gcGxhY2UucGhvdG9zWzBdLnBob3RvX3JlZmVyZW5jZTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICByZWYgPSBcIm51bGxcIjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBwbGFjZXMucHVzaChuZXcgUGxhY2UocGxhY2UucGxhY2VfaWQsIHBsYWNlLm5hbWUsXHJcbiAgICAgICAgICAgICAgcGxhY2UuZ2VvbWV0cnkubG9jYXRpb24sIHRoaXMuZ2V0UGxhY2VUeXBlKGkpLCByZWYpKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgaSsrO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBwbGFjZXM7XHJcbiAgICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHBsYWNlc0V4aXN0KCk6IGJvb2xlYW4ge1xyXG4gICAgbGV0IHZhbCA9IHRoaXMuc2VjdXJlU3RvcmFnZS5nZXRTeW5jKHtrZXk6IFwicGxhY2VzRGF0YVwifSk7XHJcbiAgICByZXR1cm4gKHZhbD09bnVsbCkgPyBmYWxzZSA6IHRydWU7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldFBsYWNlVHlwZShpKTogUGxhY2VUeXBlIHtcclxuICAgIGxldCBwbGFjZTogUGxhY2VUeXBlO1xyXG4gICAgc3dpdGNoIChpKSB7XHJcbiAgICAgIGNhc2UgMDogcmV0dXJuIFBsYWNlVHlwZS5QQVJLO1xyXG4gICAgICBjYXNlIDE6IHJldHVybiBQbGFjZVR5cGUuUkVTVEFVUkFOVDtcclxuICAgICAgY2FzZSAyOiByZXR1cm4gUGxhY2VUeXBlLk1VU0VVTTtcclxuICAgICAgY2FzZSAzOiByZXR1cm4gUGxhY2VUeXBlLkFSVF9HQUxMRVJZO1xyXG4gICAgICBjYXNlIDQ6IHJldHVybiBQbGFjZVR5cGUuQ0FGRTtcclxuICAgICAgY2FzZSA1OiByZXR1cm4gUGxhY2VUeXBlLkNBU0lOTztcclxuICAgICAgY2FzZSA2OiByZXR1cm4gUGxhY2VUeXBlLlpPTztcclxuICAgICAgY2FzZSA3OiByZXR1cm4gUGxhY2VUeXBlLlNIT1BQSU5HX01BTEw7XHJcbiAgICAgIGNhc2UgODogcmV0dXJuIFBsYWNlVHlwZS5CQVI7XHJcbiAgICAgIGNhc2UgOTogcmV0dXJuIFBsYWNlVHlwZS5OSUdIVF9DTFVCO1xyXG4gICAgICBjYXNlIDEwOiByZXR1cm4gUGxhY2VUeXBlLlBPSU5UX09GX0lOVEVSRVNUO1xyXG4gICAgfVxyXG4gIH1cclxuICBwdWJsaWMgc3RvcmVQbGFjZXMocGxhY2VzOiBBcnJheTxQbGFjZT4pIHtcclxuICAgIHJldHVybiB0aGlzLnNlY3VyZVN0b3JhZ2Uuc2V0KHtrZXk6IFwicGxhY2VzRGF0YVwiLCB2YWx1ZTogSlNPTi5zdHJpbmdpZnkocGxhY2VzKX0pO1xyXG4gIH1cclxuICBwdWJsaWMgZ2V0U2F2ZWRQbGFjZXMoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5zZWN1cmVTdG9yYWdlLmdldCh7a2V5OiBcInBsYWNlc0RhdGFcIn0pO1xyXG4gIH1cclxuXHJcbn1cclxuIl19